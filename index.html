<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversando con Chat GPT</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
</br>
</br>
</br>
</br>
</br>
</br>
<div style="text-align: center;">
    <div style="text-align: center;">
        <button type="submit" style="font-size:24px" id="btnTranscribe">Pregunta a Chat GPT</br></br><i class="material-icons">mic</i></button>
    </div>
    
</div>


<div style="text-align: center;">
<div style="text-align: center;" id="microOn">
    (((<i class="material-icons">mic</i>)))
</div>
</div>

</br>

</br>
<div style="text-align: center;">
<textarea id="textArea" cols="100" rows="20"></textarea>
</div>
</br>
<div style="text-align: center;">
    <button style="font-size:18px" id="btnCall">Llamar ChatGPT</button>
</div>
</br>
<div style="text-align: center;" id="loading">
    <i style="font-size: 48px; color: blue; animation: spin 1s linear infinite;" class="material-icons">refresh</i>
    Cargando...
</div>
</br>
<div style="text-align: center;">
    <textarea id="textAreaResp" cols="100" rows="50"></textarea>
</div>


<script>
    const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const btnCall = document.getElementById('btnCall');
const textArea = document.getElementById('textArea');
const textAreaResp = document.getElementById('textAreaResp');
const btnTranscribe = document.getElementById('btnTranscribe');
const div = document.getElementById("loading");
const mic = document.getElementById("microOn");

const recognition = new webkitSpeechRecognition();

const APIKEY = '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';
var texto = "";
var cargando = false;
var primerMensaje = 0;
var isTranscribing = false;
let transcriber = null;

const ObjConversacion = {
    model: 'gpt-3.5-turbo',
    messages: [
        {
            role: 'user', 
            content: texto
        }
    ],
  };

recognition.continuous = true;
recognition.lang = 'es-ES';
recognition.interimResult = false;

actualizarDiv();
actualizarMic();


btnCall.addEventListener('click', () => {
    valor = textArea.value;
    response = llamarApi(valor);  
});

btnTranscribe.addEventListener('mousedown', () => {
  isTranscribing = true;
  actualizarMic();
  recognition.start();
});

btnTranscribe.addEventListener('mouseup', () => {
  isTranscribing = false;
  actualizarMic();
  recognition.stop();
});

recognition.onresult = (event) => {
    texto = event.results[event.results.length - 1][0].transcript;
    textArea.value = texto;
    response = llamarApi(texto);
}

function leerTexto(text) {
    const speech = new SpeechSynthesisUtterance(text);
    speech.volume = 1;
    speech.rate = 2;
    speech.pitch = 1;
    speech.lang = 'es-ES'
  
    window.speechSynthesis.speak(speech);
}

function actualizarDiv() {
    if (cargando) {
      div.style.display = "block";
    } else {
      div.style.display = "none";
    }
}

function actualizarMic() {
    if (isTranscribing) {
        mic.style.display = "block";
    } else {
        mic.style.display = "none";
    }
}

function llamarApi (texto){
    cargando = true;
    actualizarDiv()
    console.log ( 'text' +texto)
    const ObjLlamada = {
        model: 'gpt-3.5-turbo',
        messages: [
            {
                role: 'user', 
                content: texto
            }
        ],
      };
    
    if (primerMensaje == 0){
        data = ObjLlamada;
        agregarMensaje('user', texto);
        primerMensaje =1
    } else {
        agregarMensaje('user', texto)
        data = ObjConversacion
    }
    
    const url = 'https://api.openai.com/v1/chat/completions';
    const options = {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer '+ APIKEY
        }
    };

    fetch(url, options)
        .then(response => {
            if (!response.ok) {
                cargando = false;
                actualizarDiv()
                throw new Error('Error al hacer la peticiÃ³n a la API');
            }
            return response.json();
        })
        .then(data => {
            cargando=false;
            actualizarDiv()
            var mensaje = data.choices[0].message.content;
            console.log(mensaje);
            textAreaResp.value = mensaje;        
            leerTexto(mensaje);
            agregarMensaje('assistant', mensaje);
            
        })
        .catch(error => {
            cargando=false;
            actualizarDiv()
            console.error(error);
        });
}

function agregarMensaje(role, content) { 
    let nuevoMensaje = {"role": role, "content": content};
    ObjConversacion.messages.push (nuevoMensaje) ;

    for (let i = 0; i < ObjConversacion.messages.length; i++) {
        console.log('Mensaje ' + i + ': ' + ObjConversacion.messages[i].role +  ': ' + ObjConversacion.messages[i].content );
      }
}

function actualizarDiv() {
    if (cargando) {
        div.style.display = "block";
    } else {
        div.style.display = "none";
    }
}

</script>
</body>

</html>
</script>
</body>

</html>
